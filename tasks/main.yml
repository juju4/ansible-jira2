---

- name: Include version-specific variables for Ubuntu.
  include_vars: "{{ ansible_distribution }}-{{ ansible_distribution_version }}.yml"
  when: ansible_os_family == "Debian"
- name: Include version-specific variables for RedHat
  include_vars: "RedHat-{{ ansible_distribution_version.split('.')[0] }}.yml"
  when: ansible_os_family == "RedHat"

- import_tasks: jira-java11-fix.yml
  when:
    - jira_version|string is version_compare('8.20.0', '>=')
    - (ansible_os_family == "Debian" and ansible_distribution_major_version|int >= 18) or
      (ansible_os_family == "RedHat" and ansible_distribution_major_version|int >= 8)

- import_tasks: backup-restore.yml

- import_tasks: security.yml

- import_tasks: jira-postgresql.yml
  when: jira_dbbackend is defined and jira_dbbackend == 'postgres'

# - import_tasks: jira-server_xml1.yml
- import_tasks: jira-server_xml2.yml

- import_tasks: jira-reverseproxy.yml
  when: jira_reverseproxy|bool

- import_tasks: jira-https.yml
  when: jira_https|bool

- import_tasks: jira-import-crt.yml

- import_tasks: jira-activedirectory.yml
  when: jira_link_activedirectory|bool

- name: install curl for serverspec testing
  package: name=curl state=present
  register: pkg_result
  until: pkg_result is success

- name: Flush handlers
  meta: flush_handlers

- name: Ensure Jira has finished to initialize
  wait_for:
    port: "{{ jira_int_port }}"
    delay: 15
  register: w1
  ignore_errors: true

- block:
    - name: 2nd jira restart
      service:
        name: jira
        state: restarted
    - name: Ensure Jira has finished to initialize 2
      wait_for:
        port: "{{ jira_int_port }}"
        delay: 15
  when: w1 is failed
